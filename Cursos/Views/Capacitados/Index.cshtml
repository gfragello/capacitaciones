@model PagedList.IPagedList<Cursos.Models.Capacitado>
@using PagedList.Mvc;
@using Cursos.Helpers;
<link href="~/Content/PagedList.css" rel="stylesheet" type="text/css" />

@{
    ViewBag.Title = "Capacitados";
}

<h2>Capacitados</h2>

<div class="mb-3">
    <div class="btn-group" role="group">
        @if (User.IsInRole("Administrador") || User.IsInRole("AdministradorExterno"))
        {
            @Html.ActionLink("Crear nuevo", "Create", null, new { @class = "btn btn-primary" })
        }
        @Html.ActionLink("Exportar a Excel", "Index",
            new
                 {
                currentNombreCompleto = ViewBag.CurrentNombreCompleto,
                currentFiltroEmpresa = ViewBag.CurrentFiltroEmpresa,
                FiltroEmpresaID = ViewBag.FiltroEmpresaID,
                currentCursoID = ViewBag.CurrentCursoID,
                exportarExcel = true
            },
            new { @class = "btn btn-primary" })
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-light">
        <a href="javascript:void(0);" class="filter-toggle" id="toggleFilters">
            Ocultar Filtros
        </a>
    </div>
    <div id="filterContent">
        <div class="card-body">
            @using (Html.BeginForm())
            {
                <div class="row">
                    <!-- Primera fila: Documento, Nombre Completo, Curso -->
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label>@Resources.ViewCapacitadosIndex.ResourceManager.GetString("lblDocumento"):</label>
                            @Html.TextBox("documento", "", new { @class = "form-control" })
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mb-3">
                            <label>Nombre o Apellido:</label>
                            @Html.TextBox("nombreCompleto", ViewBag.CurrentNombreCompleto as string, new { @class = "form-control", placeholder = "Buscar por nombre, apellido o ambos..." })
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="form-group mb-3">
                            <label>@Resources.ViewCapacitadosIndex.ResourceManager.GetString("lblCurso"):</label>
                            @Html.DropDownList("CursoID", null, new { @class = "form-control" })
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Segunda fila: Empresa con más espacio y botones -->
                    <div class="col-md-8">
                        <div class="form-group mb-3">
                            <label>@Resources.ViewCapacitadosIndex.ResourceManager.GetString("lblEmpresa"):</label>
                            @if (User.IsInRole("ConsultaEmpresa"))
                            {
                                <div class="form-control" style="background-color: #f5f5f5; color: #333;">
                                    @ViewBag.CurrentFiltroEmpresa
                                </div>
                                @Html.Hidden("filtroEmpresa", ViewBag.CurrentFiltroEmpresa as string)
                                @Html.Hidden("FiltroEmpresaID", ViewBag.FiltroEmpresaID as int? ?? 0)
                            }
                            else
                            {
                                <div style="position: relative;">
                                    @Html.TextBox("filtroEmpresa", ViewBag.CurrentFiltroEmpresa as string, new
                                    {
                                        @class = "form-control filtro-empresa-input",
                                        autocomplete = "off",
                                        id = "filtroEmpresa",
                                        placeholder = "Buscar empresa por nombre, RUT o razón social...",
                                        style = "padding-right:2rem;"
                                    })
                                    @Html.Hidden("FiltroEmpresaID", ViewBag.FiltroEmpresaID as int? ?? 0, new { id = "FiltroEmpresaID" })
                                    <div id="sugerencias-empresas" class="list-group sugerencias-empresas-dropdown"
                                         style="position: absolute; z-index: 999; width: 100%; display:none;">
                                    </div>
                                    <span id="clearFiltroEmpresa"
                                          title="Borrar filtro de empresa"
                                          style="position: absolute; top: 50%; right: 0.25rem; transform: translateY(-50%); cursor: pointer; padding: 0.25rem 0.5rem;">
                                        <i class="fa fa-times text-secondary"></i>
                                    </span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="form-group mb-3" style="margin-top: 25px;">
                            <div class="btn-group" role="group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-search"></i>
                                    @Resources.ViewCapacitadosIndex.ResourceManager.GetString("btnBuscar")
                                </button>
                                <a href="@Url.Action("Index")" class="btn btn-secondary">
                                    <i class="fa fa-eraser"></i> Limpiar filtros
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@Html.PagedListPager(Model, page => Url.Action("Index", new { page, currentNombreCompleto = ViewBag.CurrentNombreCompleto, currentFiltroEmpresa = ViewBag.CurrentFiltroEmpresa, FiltroEmpresaID = ViewBag.FiltroEmpresaID, currentCursoID = ViewBag.CurrentCursoID }))

@Html.Partial("_ListCapacitadosPartial", Model)

<br />
P&aacute;gina @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) de @Model.PageCount

@Html.PagedListPager(Model, page => Url.Action("Index", new { page, currentNombreCompleto = ViewBag.CurrentNombreCompleto, currentFiltroEmpresa = ViewBag.CurrentFiltroEmpresa, FiltroEmpresaID = ViewBag.FiltroEmpresaID, currentCursoID = ViewBag.CurrentCursoID }))

@section scripts {
    <script src="~/Scripts/empresa-autocomplete.js"></script>
    <link rel="stylesheet" href="~/Content/empresa-autocomplete.css" />
    <script>
        $(function () {
            // Inicializar tooltips de Bootstrap 3
            $('[data-toggle="tooltip"]').tooltip();
            
            // Solo inicializar autocompletado si el usuario no tiene rol ConsultaEmpresa
            @if (!User.IsInRole("ConsultaEmpresa"))
            {
                <text>
                initEmpresaAutocomplete({
                    inputId: "filtroEmpresa",
                    hiddenId: "FiltroEmpresaID",
                    sugerenciasId: "sugerencias-empresas",
                    urlAutocomplete: '@Url.Action("AutocompleteEmpresa", "Capacitados")',
                    placeholder: "Buscar empresa por nombre, RUT o razón social...",
                    mensajeNoEncontrada: "No se encontraron empresas",
                    showClearIcon: true,
                    minLength: 3,
                    enableTooltips: true
                });
                </text>
            }
        });
    </script>
}